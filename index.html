<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EquilibriFun : ì¹´ë“œë¡œ ì—¬ëŠ” í™”í•™í‰í˜•ì˜ ì„¸ê³„</title>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <!-- jQuery ìµœì‹  ë²„ì „ ì¶”ê°€ -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f0f4f8;
      margin: 0;
      padding: 40px;
    }
    h1 {
      text-align: center;
      color: #2c3e50;
      margin-bottom: 50px;
    }
    .menu-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      padding: 20px;
      max-width: 1200px;
      margin: 0 auto;
      margin-bottom: 100px;
    }
    .menu-card {
      background: white;
      padding: 30px;
      border-radius: 16px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.08);
      transition: transform 0.2s ease;
    }
    .menu-card:hover {
      transform: translateY(-5px);
    }
    .menu-card a {
      text-decoration: none;
      color: #2c3e50;
      font-weight: bold;
      font-size: 18px;
    }
    .menu-card h3 {
      margin-top: 0;
      margin-bottom: 10px;
      color: #2980b9;
    }
    .chatbot-container {
      position: fixed;
      bottom: 40px;
      right: 40px;
      width: 300px;
      background-color: white;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      z-index: 1000;
      transition: transform 0.3s ease;
    }
    .chatbot-container:hover {
      transform: translateY(-5px);
    }
    .chatbot-header {
      background-color: #2196F3;
      color: white;
      padding: 15px;
      border-radius: 10px 10px 0 0;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .chatbot-header h3 {
      margin: 0;
      font-size: 16px;
    }
    .chatbot-header button {
      background-color: transparent;
      border: none;
      color: white;
      cursor: pointer;
      padding: 5px 10px;
      border-radius: 5px;
      transition: background-color 0.3s;
    }
    .chatbot-header button:hover {
      background-color: rgba(255, 255, 255, 0.2);
    }
    .chatbot-content {
      padding: 15px;
      max-height: 300px;
      overflow-y: auto;
    }
    .chatbot-input {
      display: flex;
      gap: 10px;
      padding: 10px;
      border-top: 1px solid #eee;
    }
    .chatbot-input input {
      flex-grow: 1;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 5px;
    }
    .chatbot-input button {
      padding: 8px 15px;
      background-color: #2196F3;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    .chatbot-input button:hover {
      background-color: #1976D2;
    }
    /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f0f4f8;
      margin: 0;
      padding: 40px;
    }
    
    /* í”„ë¡œí•„ ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼ */
    .profile-image {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background-color: #e0e0e0;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto;
      overflow: hidden;
    }
    
    .profile-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .profile-image-placeholder {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background-color: #e0e0e0;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto;
    }
    
    .profile-image-placeholder::before {
      content: "ğŸ‘¤";
      font-size: 40px;
    }
    
    .popup-button {
      background: #3498db;
      color: white;
      border: none;
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 12px;
      margin-left: 10px;
      cursor: pointer;
      transition: background 0.3s ease;
    }
    
    .popup-button:hover {
      background: #2980b9;
    }

    .upload-container {
      max-width: 600px;
      margin: 0 auto;
      padding: 20px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .upload-instructions {
      margin-bottom: 20px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
    }

    .upload-instructions h3 {
      margin-top: 0;
      color: #2c3e50;
    }

    .upload-instructions ol {
      padding-left: 20px;
      margin-bottom: 0;
    }

    .upload-area {
      border: 2px dashed #3498db;
      border-radius: 8px;
      padding: 30px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .upload-area:hover {
      border-color: #2980b9;
      background: #f8f9fa;
    }

    .upload-prompt {
      color: #7f8c8d;
    }

    .upload-prompt i {
      font-size: 48px;
      margin-bottom: 10px;
    }

    .preview-container {
      margin-top: 20px;
    }

    .preview-container img {
      max-width: 100%;
      border-radius: 8px;
    }

    .retake-btn {
      margin-top: 10px;
      padding: 8px 16px;
      background: #e74c3c;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .processing-status {
      text-align: center;
      margin: 20px 0;
    }

    .spinner {
      width: 40px;
      height: 40px;
      margin: 0 auto;
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3498db;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .result-container {
      margin-top: 20px;
      padding: 20px;
      background: #f8f9fa;
      border-radius: 8px;
      text-align: center;
    }

    .ph-value {
      font-size: 48px;
      font-weight: bold;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    .ph-value .number {
      color: #2c3e50;
    }

    .ph-value .indicator {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      display: inline-block;
    }

    .ph-description {
      font-size: 18px;
      color: #7f8c8d;
      margin-bottom: 15px;
    }

    .ph-scale {
      width: 100%;
      height: 20px;
      background: linear-gradient(to right, 
        #ff0000 0%, #ff0000 20%,  /* ë¹¨ê°• (pH 0-3) */
        #ff8000 20%, #ff8000 40%,  /* ì£¼í™© (pH 4-5) */
        #ffff00 40%, #ffff00 50%,  /* ë…¸ë‘ (pH 6) */
        #00ff00 50%, #00ff00 60%,  /* ì´ˆë¡ (pH 7) */
        #0000ff 60%, #0000ff 100%  /* íŒŒë‘ (pH 8-14) */
      );
      border-radius: 10px;
      margin: 10px 0;
      position: relative;
    }

    .ph-marker {
      position: absolute;
      width: 4px;
      height: 30px;
      background: white;
      top: -5px;
      transform: translateX(-50%);
      box-shadow: 0 0 5px rgba(0,0,0,0.3);
    }

    .ph-labels {
      display: flex;
      justify-content: space-between;
      margin-top: 5px;
      font-size: 12px;
      color: #7f8c8d;
    }

    .processing-time {
      font-size: 12px;
      color: #95a5a6;
      margin-top: 10px;
    }
  </style>
</head>
<body>

    <div id="user-info" style="position: absolute; top: 0; right: 30px; font-size: 13px; color: #34495e;"></div>

    <!-- ë¡œê·¸ì¸ ìƒíƒœì— ë”°ë¼ í‘œì‹œë˜ëŠ” ë©”ë‰´ -->
    <div id="auth-buttons" style="position: absolute; top: 20px; right: 30px; font-size: 14px; display: block;">
      <a href="firebase/login.html" style="margin-right: 10px; text-decoration: none; color: #2c3e50;">ğŸ” ë¡œê·¸ì¸</a>
      <a href="firebase/register.html" style="margin-right: 10px; text-decoration: none; color: #2c3e50;">ğŸ“ íšŒì›ê°€ì…</a>
      <a href="firebase/profile.html" style="margin-right: 10px; text-decoration: none; color: #2c3e50;">ğŸ‘¤ í”„ë¡œí•„</a>
      <a href="firebase/teacher_dashboard.html" id="teacher-dashboard-link" style="text-decoration: none; color: #2c3e50; display: none;">ğŸ“‹ êµì‚¬ìš© ëŒ€ì‹œë³´ë“œ</a>
    </div>

    <!-- ë¡œê·¸ì¸ëœ ìƒíƒœì—ì„œ í‘œì‹œë˜ëŠ” ë©”ë‰´ -->
    <div id="user-menu" style="position: absolute; top: 20px; right: 30px; font-size: 14px; display: none;">
      <a href="firebase/profile.html" style="margin-right: 10px; text-decoration: none; color: #2c3e50;">ğŸ‘¤ í”„ë¡œí•„</a>
      <a href="firebase/teacher_dashboard.html" id="teacher-dashboard-link-logged" style="text-decoration: none; color: #2c3e50; display: none;">ğŸ“‹ êµì‚¬ìš© ëŒ€ì‹œë³´ë“œ</a>
      <a href="#" onclick="logout()" style="margin-right: 10px; text-decoration: none; color: #c00;">ğŸšª ë¡œê·¸ì•„ì›ƒ</a>
    </div>

  <h1>EquilibriFun : ì¹´ë“œë¡œ ì—¬ëŠ” í™”í•™ í‰í˜•ì˜ ì„¸ê³„</h1>

  <div class="menu-container">
    <div class="menu-card">
      <h3>1. í™”í•™ í‰í˜• ì¹´ë“œê²Œì„</h3>
      <a href="cardgame/web_version/index.html">ğŸƒ ë™ì‹œì— ì¹´ë“œ ë’¤ì§‘ê¸°</a>
      <a href="cardgame/web_version2/index.html" style="display: block; margin-top: 10px;">ğŸƒ ì°¨ë¡€ëŒ€ë¡œ ì¹´ë“œ ë’¤ì§‘ê¸°</a>
      <p style="margin-top: 10px; font-size: 14px; color: #666;">
        ë¹¨ê°„ìƒ‰ê³¼ íŒŒë€ìƒ‰ ì¹´ë“œì˜ ë³€í™”ë¥¼ í†µí•´ í™”í•™í‰í˜•ì˜ ì›ë¦¬ë¥¼ ì‹œê°ì ìœ¼ë¡œ ì´í•´í•´ë³´ì„¸ìš”.<br>
        ì‹¤ì‹œê°„ ê·¸ë˜í”„ë¡œ í‰í˜•ì˜ ë³€í™”ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
      </p>
    </div>
    <div class="menu-card">
      <h3>2. ì½˜í…ì¸  í•™ìŠµ- ê°œë°œ ì¤‘</h3>
      <ul>
        <li><a href="contents/concept_intro.html">ğŸ“˜ í™”í•™ í‰í˜•ì˜ ì´í•´</a></li>
        <li><a href="contents/history.html">ğŸ“œ ì—­ì‚¬ ì†ì˜ í™”í•™ í‰í˜•</a></li>
        <li><a href="contents/daily_life.html">ğŸ  ìƒí™œ ì†ì˜ í™”í•™ í‰í˜•</a></li>
        <li><a href="contents/equilibrium_constant.html">ğŸ“ í™”í•™ í‰í˜•ê³¼ í‰í˜• ìƒìˆ˜</a></li>
      </ul>
    </div>
    <div class="menu-card">
      <h3>3. í•™ìŠµí™œë™</h3>
      <a href="student_activity/student_activity.html">ğŸ‘©â€ğŸ”¬ ì˜¤í”ˆì†ŒìŠ¤ ì—”ì§„ ê¸°ë°˜ í™œë™ - ê°œë°œ ì¤‘</a>
      <a href="student_activity/ph_measurement/index.html" style="display: block; margin-top: 10px;">ğŸ¨ ì‚°-ì—¼ê¸° í‰í˜•: pH ì¸¡ì • ì¸ê³µì§€ëŠ¥ - ê³µì‚¬ ì¤‘</a>
      <p style="margin-top: 10px; font-size: 14px; color: #666;">
        ë³€ìƒ‰ëœ ë§ŒëŠ¥ì‹œí—˜ì§€ ì‚¬ì§„ì„ ì´ìš©í•´ì„œ ì‚°ì„±ê³¼ ì—¼ê¸°ì„±ì„ ì•Œì•„ë³´ì„¸ìš”!<br>
        ì¸ê³µì§€ëŠ¥ì„ ì´ìš©í•˜ì—¬ ë§ŒëŠ¥ ì‹œí—˜ì§€ ì‚¬ì§„ì„ ë¶„ì„í•˜ì—¬ pHê°’ì„ ë¶„ì„í•˜ê³  ì˜ˆì¸¡í•©ë‹ˆë‹¤.
      </p>
    </div>
    <div class="menu-card">
      <h3>4. í™”í•™ í‰í˜• ì‹œë®¬ë ˆì´ì…˜</h3>
      <a href="simulation/ì•”ëª¨ë‹ˆì•„ì˜ ìƒì„±ë°˜ì‘(í•˜ë²„-ë³´ìŠˆë²•)/haber.html">ğŸŒ¡ï¸ ì•”ëª¨ë‹ˆì•„ì˜ ìƒì„±ë°˜ì‘(í•˜ë²„-ë³´ìŠˆë²•)</a>
      <p style="margin-top: 10px; font-size: 14px; color: #666;">
        ì•”ëª¨ë‹ˆì•„ í•©ì„± ë°˜ì‘ì„ ì‹œë®¬ë ˆì´ì…˜í•´ë³´ì„¸ìš”!<br>
        ì˜¨ë„, ì••ë ¥, ì´‰ë§¤ ë“±ì˜ ì¡°ê±´ì„ ë³€í™”ì‹œí‚¤ë©° í‰í˜• ì´ë™ì„ ê´€ì°°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
      </p>
    </div>
    <div class="menu-card">
      <h3>5. í˜•ì„±í‰ê°€ í™œë™</h3>
      <a href="equilibrium_run/equilibrium_run.html">ğŸ“ ê²Œì„: Equilibrium Runner</a>
      <p style="margin-top: 10px; font-size: 14px; color: #666;">
        ì¬ë¯¸ìˆëŠ” ê²Œì„ì„ í†µí•´ í™”í•™ í‰í˜•ì„ ë°°ì›Œë³´ì„¸ìš”!<br>
        ê²Œì„ì€ "ì´ˆê¸°ë°˜ì‘ì†ë„ê°€ ë³€í™”í•˜ì—¬ ì •ë°˜ì‘ ì†ë„ì™€ ì—­ë°˜ì‘ ì†ë„ê°€ ê°™ìœ¼ë©´ ë™ì  í‰í˜•"ì´ë¼ëŠ” ì•„ì´ë””ì–´ê°€ ê¸°ì´ˆê°€ ë˜ì—ˆìŠµë‹ˆë‹¤.
      </p>
    </div>
    <div class="menu-card">
      <h3>6. í•™ìŠµ í˜„í™©</h3>
      <a href="student_dashboard.html">ğŸ“Š í•™ìŠµ í˜„í™© í™•ì¸í•˜ê¸°</a>
      <p style="margin-top: 10px; font-size: 14px; color: #666;">
        ê° í™œë™ì˜ ì§„í–‰ ìƒí™©ì„ í™•ì¸í•˜ì„¸ìš”.<br>
      
      </p>
    </div>
  <div class="menu-card">
      <h3>7. í•™ìƒ ì„¤ë¬¸ì¡°ì‚¬</h3>
      <a href="https://forms.gle/BaFP11e5UkNZeh798">ğŸ“Š í•™ìƒ ì„¤ë¬¸ì¡°ì‚¬ ë° ì‚¬ìš©ì í”¼ë“œë°±</a>
      <p style="margin-top: 10px; font-size: 14px; color: #666;">
        í•™ìƒë“¤ì€ ì„¤ë¬¸ì¡°ì‚¬ì— ì‘ë‹µí•˜ê³ , ë¡œê·¸ì¸ ê¸°ëŠ¥ê³¼ ì±—ë´‡ ê¸°ëŠ¥ì„ ì œì™¸í•œ SWì— ëŒ€í•œ ì˜ê²¬ì„ ë‚¨ê²¨ì£¼ì„¸ìš”.<br>
      
      </p>
    </div>
  </div>

  <div class="chatbot-container">
    <div class="chatbot-header">
      <h3>ğŸ‘¨â€ğŸ”¬ ë¥´ìƒ¤í‹€ë¦¬ì—ì™€ ëŒ€í™”í•˜ê¸°</h3>
      <button onclick="openChatbot()" class="popup-button">í¬ê²Œ ë³´ê¸°</button>
    </div>
    <div class="chatbot-content">
      <div id="chat-log" class="chatbot-log" style="max-height: 200px; overflow-y: auto; padding: 10px;"></div>
      <div class="chatbot-input">
        <input id="chat-input" type="text" placeholder="ë¥´ìƒ¤í‹€ë¦¬ì—ì—ê²Œ ì§ˆë¬¸í•˜ì„¸ìš”..." onkeypress="if(event.key==='Enter'){sendMessage()}" style="padding: 8px; border: 1px solid #ddd; border-radius: 5px; flex-grow: 1;">
        <button onclick="sendMessage()">ë³´ë‚´ê¸°</button>
      </div>
    </div>
  </div>

  <script>
    // Firebase ì´ˆê¸°í™”
    const firebaseConfig = {
      apiKey: "AIzaSyBE0r282qiZAoL6MCYbpLt-Zmxp7JDYMVk",
      authDomain: "test-equilibrifun.firebaseapp.com",
      projectId: "test-equilibrifun",
      storageBucket: "test-equilibrifun.appspot.com",
      messagingSenderId: "804507284339",
      appId: "1:804507284339:web:d03de182b9e8fadccb0b06"
    };

    // Firebase ì´ˆê¸°í™” (ì¤‘ë³µ ë°©ì§€)
    if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
    }

    // ì±—ë´‡ ì„œë²„ URL ì„¤ì •
    const CHATBOT_API_URL = '/chat';
    
    // ì±„íŒ… ë¡œê·¸ì— ë©”ì‹œì§€ ì¶”ê°€
    function addMessage(message, isUser) {
      const chatLog = document.getElementById('chat-log');
      const messageDiv = document.createElement('div');
      messageDiv.className = isUser ? 'user-message' : 'bot-message';
      messageDiv.style.margin = '5px 0';
      messageDiv.style.padding = '8px 12px';
      messageDiv.style.borderRadius = '8px';
      messageDiv.style.maxWidth = '80%';
      messageDiv.style.wordWrap = 'break-word';
      
      if (isUser) {
        messageDiv.style.backgroundColor = '#e3f2fd';
        messageDiv.style.marginLeft = 'auto';
      } else {
        messageDiv.style.backgroundColor = '#f5f5f5';
      }
      
      messageDiv.textContent = message;
      chatLog.appendChild(messageDiv);
      chatLog.scrollTop = chatLog.scrollHeight;
    }

    // WebSocket ì—°ê²° ê´€ë¦¬
    let socket;
    let reconnectAttempts = 0;
    const maxReconnectAttempts = 5;
    let connectionStatus = 'disconnected';
    let currentMessage = '';
    let currentMessageSpan = null;

    // ì—°ê²° ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
    function updateConnectionStatus(status) {
        connectionStatus = status;
        const statusElement = document.getElementById('connection-status');
        if (statusElement) {
            statusElement.textContent = status === 'connected' ? 'ì—°ê²°ë¨' : 
                                      status === 'connecting' ? 'ì—°ê²° ì¤‘...' : 'ì—°ê²° ëŠê¹€';
            statusElement.style.color = status === 'connected' ? 'green' : 
                                      status === 'connecting' ? 'orange' : 'red';
        }
    }

    // WebSocket ì—°ê²° í•¨ìˆ˜
    function connectWebSocket() {
        if (socket) {
            socket.close();
        }

        updateConnectionStatus('connecting');
        
        try {
            socket = io('http://localhost:5000', {
                transports: ['websocket'],
                reconnection: true,
                reconnectionAttempts: maxReconnectAttempts,
                reconnectionDelay: 3000
            });

            socket.on('connect', () => {
                console.log('WebSocket ì—°ê²° ì„±ê³µ');
                updateConnectionStatus('connected');
                reconnectAttempts = 0;
            });

            socket.on('disconnect', () => {
                console.log('WebSocket ì—°ê²° ì¢…ë£Œ');
                updateConnectionStatus('disconnected');
                attemptReconnect();
            });

            socket.on('error', (error) => {
                console.error('WebSocket ì˜¤ë¥˜:', error);
                updateConnectionStatus('disconnected');
                attemptReconnect();
            });

            socket.on('stream', (data) => {
                console.log('ìŠ¤íŠ¸ë¦¼ ë°ì´í„° ìˆ˜ì‹ :', data);
                if (!currentMessageSpan) {
                    const chatLog = document.getElementById('chat-log');
                    const messageDiv = document.createElement('div');
                    messageDiv.className = 'bot-message';
                    messageDiv.style.margin = '5px 0';
                    messageDiv.style.padding = '8px 12px';
                    messageDiv.style.borderRadius = '8px';
                    messageDiv.style.maxWidth = '80%';
                    messageDiv.style.wordWrap = 'break-word';
                    messageDiv.style.backgroundColor = '#f5f5f5';
                    
                    currentMessageSpan = document.createElement('span');
                    currentMessageSpan.style.display = 'inline';
                    messageDiv.appendChild(currentMessageSpan);
                    chatLog.appendChild(messageDiv);
                    chatLog.scrollTop = chatLog.scrollHeight;
                }

                currentMessage += data.char;
                currentMessageSpan.innerHTML = formatChemicalFormula(currentMessage);

                if (data.is_last) {
                    currentMessage = '';
                    currentMessageSpan = null;
                }
            });

        } catch (error) {
            console.error('WebSocket ì—°ê²° ì‹¤íŒ¨:', error);
            updateConnectionStatus('disconnected');
            attemptReconnect();
        }
    }

    // ì¬ì—°ê²° ì‹œë„ í•¨ìˆ˜
    function attemptReconnect() {
        if (reconnectAttempts < maxReconnectAttempts) {
            reconnectAttempts++;
            console.log(`ì¬ì—°ê²° ì‹œë„ ${reconnectAttempts}/${maxReconnectAttempts}`);
            setTimeout(connectWebSocket, 3000);
        } else {
            console.log('ìµœëŒ€ ì¬ì—°ê²° ì‹œë„ íšŸìˆ˜ ë„ë‹¬');
            updateConnectionStatus('disconnected');
            addMessage('ì„œë²„ì™€ì˜ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', false);
        }
    }

    // í™”í•™ì‹ í‘œì‹œ í•¨ìˆ˜
    function formatChemicalFormula(text) {
        return text.replace(/([A-Z][a-z]?\d*)/g, '<span class="formula">$1</span>');
    }

    // ë©”ì‹œì§€ ì „ì†¡ í•¨ìˆ˜
    function sendMessage() {
        const input = document.getElementById('chat-input');
        const message = input.value.trim();
        
        if (!message) return;
        
        if (connectionStatus !== 'connected') {
            addMessage('ì„œë²„ì™€ ì—°ê²°ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', false);
            return;
        }
        
        addMessage(message, true);
        input.value = '';
        
        try {
            console.log('ë©”ì‹œì§€ ì „ì†¡:', message);
            socket.emit('message', { message: message });
        } catch (error) {
            console.error('ë©”ì‹œì§€ ì „ì†¡ ì˜¤ë¥˜:', error);
            addMessage('ë©”ì‹œì§€ ì „ì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', false);
        }
    }

    function openChatbot() {
      const width = 800;
      const height = 600;
      const left = (window.innerWidth - width) / 2;
      const top = (window.innerHeight - height) / 2;
      
      window.open('chatbot-server/lechatelier_bot.html', 'ë¥´ìƒ¤í‹€ë¦¬ì— ì±—ë´‡', 
        `width=${width},height=${height},left=${left},top=${top},resizable=yes,scrollbars=yes`);
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ WebSocket ì—°ê²°
    document.addEventListener('DOMContentLoaded', () => {
        // ì—°ê²° ìƒíƒœ í‘œì‹œ ìš”ì†Œ ì¶”ê°€
        const statusDiv = document.createElement('div');
        statusDiv.id = 'connection-status';
        statusDiv.style.position = 'fixed';
        statusDiv.style.bottom = '10px';
        statusDiv.style.right = '10px';
        statusDiv.style.padding = '5px 10px';
        statusDiv.style.backgroundColor = 'white';
        statusDiv.style.borderRadius = '5px';
        statusDiv.style.boxShadow = '0 2px 5px rgba(0,0,0,0.2)';
        document.body.appendChild(statusDiv);

        // WebSocket ì—°ê²° ì‹œì‘
        connectWebSocket();
    });
  </script>

  <script type="module">
    document.addEventListener('DOMContentLoaded', async function() {
      // Firebase ì„œë¹„ìŠ¤ ì¸ìŠ¤í„´ìŠ¤
      const auth = firebase.auth();
      
      // ì¸ì¦ ì§€ì†ì„± ì„¤ì •
      try {
        await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
        console.log('ì¸ì¦ ì§€ì†ì„±ì´ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
      } catch (error) {
        console.error('ì¸ì¦ ì§€ì†ì„± ì„¤ì • ì˜¤ë¥˜:', error);
      }

      const db = firebase.firestore();
      
      // Firestore ì„¤ì •
      db.settings({
        cacheSizeBytes: firebase.firestore.CACHE_SIZE_UNLIMITED,
        merge: true,
        experimentalAutoDetectLongPolling: true,
        useFetchStreams: false,
        ignoreUndefinedProperties: true,
        cache: {
          type: 'persistent',
          synchronizeTabs: true
        }
      });

      // ì¸ì¦ ìƒíƒœ ë³€ê²½ ë¦¬ìŠ¤ë„ˆ
      auth.onAuthStateChanged(async (user) => {
        try {
          console.log('ì¸ì¦ ìƒíƒœ ë³€ê²½ ê°ì§€:', user ? 'ë¡œê·¸ì¸ë¨' : 'ë¡œê·¸ì•„ì›ƒë¨');
          
          const userInfoDiv = document.getElementById('user-info');
          const authButtonsDiv = document.getElementById('auth-buttons');
          const userMenuDiv = document.getElementById('user-menu');
          const teacherDashboardLink = document.getElementById('teacher-dashboard-link');
          const teacherDashboardLinkLogged = document.getElementById('teacher-dashboard-link-logged');
          
          if (user) {
            // ì‚¬ìš©ì ì •ë³´ í‘œì‹œ
            userInfoDiv.innerHTML = `
              <small style="color: #555;">
                ğŸ‘¤ ë¡œê·¸ì¸: <b>${user.displayName || user.email}</b>
              </small>
            `;
            
            authButtonsDiv.style.display = 'none';
            userMenuDiv.style.display = 'block';
            
            teacherDashboardLink.style.display = 'none';
            teacherDashboardLinkLogged.style.display = 'none';
          } else {
            userInfoDiv.innerHTML = '';
            authButtonsDiv.style.display = 'block';
            userMenuDiv.style.display = 'none';
            teacherDashboardLink.style.display = 'none';
            teacherDashboardLinkLogged.style.display = 'none';
          }
        } catch (error) {
          console.error('ì‚¬ìš©ì ìƒíƒœ ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜:', error);
        }
      });

      // ë¡œê·¸ì•„ì›ƒ í•¨ìˆ˜ë¥¼ ì „ì—­ ìŠ¤ì½”í”„ì— ì¶”ê°€
      window.logout = async function() {
        try {
          await auth.signOut();
          window.location.href = 'index.html';
        } catch (error) {
          console.error('ë¡œê·¸ì•„ì›ƒ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
        }
      };
    });
  </script>

</body>
</html>
