<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‚°-ì—¼ê¸° í‰í˜•: pH ì¸¡ì • ì¸ê³µì§€ëŠ¥</title>
    <style>
        body {
            font-family: 'Segoe UI', sans-serif;
            background: #f0f4f8;
            margin: 0;
            padding: 40px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 16px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.08);
        }
        
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
        }
        
        .camera-instructions {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .camera-instructions h2 {
            margin-top: 0;
            color: #2c3e50;
        }
        
        .camera-instructions ol {
            padding-left: 20px;
            margin-bottom: 0;
        }
        
        .mode-selector {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .mode-button {
            padding: 15px 30px;
            background: #e3f2fd;
            border: 2px solid #2196f3;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            width: 200px;
        }
        
        .mode-button:hover {
            background: #bbdefb;
        }
        
        .mode-button.active {
            background: #2196f3;
            color: white;
        }
        
        .mode-button i {
            font-size: 24px;
            margin-bottom: 10px;
            display: block;
        }
        
        .mode-content {
            display: none;
        }
        
        .mode-content.active {
            display: block;
        }
        
        .upload-instructions {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .upload-area {
            border: 2px dashed #2196f3;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 20px;
        }
        
        .upload-area:hover {
            background: #e3f2fd;
        }
        
        .upload-area i {
            font-size: 48px;
            color: #2196f3;
            margin-bottom: 10px;
        }
        
        .upload-area p {
            margin: 0;
            color: #666;
        }
        
        .camera-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            margin-bottom: 20px;
        }
        
        .camera-container video {
            width: 100%;
            border-radius: 8px;
        }
        
        .camera-container canvas {
            display: none;
        }
        
        .camera-container img {
            display: none;
            width: 100%;
            border-radius: 8px;
        }
        
        .detection-box {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            height: 60%;
            border: 2px dashed #3498db;
            border-radius: 8px;
            pointer-events: none;
        }
        
        .status-message {
            text-align: center;
            margin: 10px 0;
            color: #2c3e50;
        }
        
        .progress-container {
            width: 100%;
            max-width: 600px;
            margin: 20px auto;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            display: none;
        }
        
        .progress-bar {
            width: 0%;
            height: 20px;
            background: #2196f3;
            transition: width 0.3s ease;
        }
        
        .progress-text {
            text-align: center;
            margin-top: 5px;
            color: #2c3e50;
            font-size: 14px;
        }
        
        .preview-container {
            width: 100%;
            max-width: 900px;
            margin: 20px auto;
            display: none;
            position: relative;
            overflow: auto;
        }
        
        .preview-image {
            width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            cursor: crosshair;
            max-height: 600px;
            object-fit: contain;
        }
        
        .selection-box {
            position: absolute;
            border: 2px solid #2196f3;
            background: rgba(33, 150, 243, 0.1);
            pointer-events: none;
            display: none;
            border-radius: 4px;
        }
        
        .selection-handle {
            position: absolute;
            width: 12px;
            height: 12px;
            background: #2196f3;
            border-radius: 50%;
            pointer-events: all;
            cursor: move;
            border: 2px solid white;
        }
        
        .selection-handle.top-left { top: -5px; left: -5px; }
        .selection-handle.top-right { top: -5px; right: -5px; }
        .selection-handle.bottom-left { bottom: -5px; left: -5px; }
        .selection-handle.bottom-right { bottom: -5px; right: -5px; }
        
        .instructions {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .instructions h2 {
            color: #2c3e50;
            margin-top: 0;
            margin-bottom: 15px;
        }
        
        .instructions ol {
            padding-left: 20px;
            margin: 0;
        }
        
        .instructions li {
            margin-bottom: 10px;
            line-height: 1.5;
        }
        
        .instructions .highlight {
            background: #e3f2fd;
            padding: 2px 5px;
            border-radius: 3px;
            font-weight: bold;
        }
        
        .preview-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }
        
        .preview-button {
            padding: 8px 16px;
            background: #2196f3;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .preview-button:hover {
            background: #1976d2;
        }
        
        .preview-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .time-estimate {
            text-align: center;
            margin-top: 5px;
            color: #666;
            font-size: 12px;
        }
        
        .button-container {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .action-button {
            background: #2196f3;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .action-button:hover {
            background: #1976d2;
        }
        
        .navigation-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        
        .nav-button {
            padding: 10px 20px;
            background: #2196f3;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .nav-button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .zoom-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 5px;
            border-radius: 4px;
            display: flex;
            gap: 5px;
            z-index: 100;
        }

        .zoom-button {
            width: 30px;
            height: 30px;
            border: none;
            background: #2196f3;
            color: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }

        /* ì²˜ìŒìœ¼ë¡œ ëŒì•„ê°€ëŠ” ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .home-button {
            position: fixed;
            top: 20px;
            left: 20px;
            padding: 12px 24px;
            background-color: #FF8A65;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            z-index: 1000;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .home-button:hover {
            background-color: #FF7043;
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
        }

        .home-button:active {
            transform: translateY(0);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
    </style>
    <script src="https://docs.opencv.org/4.5.5/opencv.js"></script>
</head>
<body>
    <!-- ì²˜ìŒìœ¼ë¡œ ëŒì•„ê°€ëŠ” ë²„íŠ¼ -->
    <button class="home-button" onclick="window.location.href='../../index.html'">
        ğŸ  ì²˜ìŒìœ¼ë¡œ
    </button>

    <div class="container">
        <h1>ğŸ“¸ ë³€ìƒ‰ëœ ë§ŒëŠ¥ ì‹œí—˜ì§€ ì´ë¯¸ì§€(ì‚¬ì§„) ìë£Œ ìˆ˜ì§‘</h1>
        
        <div class="mode-selector">
            <div class="mode-button active" id="cameraMode">
                <i>ğŸ“·</i>
                <h3>ì¹´ë©”ë¼ë¡œ ì°ê¸°</h3>
                <p>ì¹´ë©”ë¼ë¥¼ ì‚¬ìš©í•˜ì—¬ ì§ì ‘ ì´¬ì˜</p>
            </div>
            <div class="mode-button" id="uploadMode">
                <i>ğŸ“</i>
                <h3>ì‚¬ì§„ ì—…ë¡œë“œ</h3>
                <p>ê¸°ì¡´ ì‚¬ì§„ì„ ì„ íƒí•˜ì—¬ ì—…ë¡œë“œ</p>
            </div>
        </div>

        <div class="mode-content active" id="cameraContent">
        <div class="camera-instructions">
                <h2>ì¹´ë©”ë¼ë¡œ ì‚¬ì§„ ì°ëŠ” ë°©ë²•</h2>
                <ol>
                    <li>ë§ŒëŠ¥ì‹œí—˜ì§€ë¥¼ í°ìƒ‰ ë°°ê²½ ì•ì— ë†“ì•„ì£¼ì„¸ìš”</li>
                    <li>ì¹´ë©”ë¼ë¥¼ ì‹œí—˜ì§€ì— ê°€ê¹Œì´ ëŒ€ì£¼ì„¸ìš”</li>
                    <li>ì‹œí—˜ì§€ê°€ íŒŒë€ìƒ‰ ë„¤ëª¨ ì•ˆì— ë“¤ì–´ê°€ë„ë¡ í•´ì£¼ì„¸ìš”</li>
                    <li>ì‚¬ì§„ì´ ì˜ ë³´ì´ë©´ "ì‚¬ì§„ ì°ê¸°" ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”</li>
            </ol>
        </div>

        <div class="camera-container">
            <video id="video" autoplay playsinline></video>
                <canvas id="canvas" style="display: none;"></canvas>
                <img id="captured-image" style="display: none;">
            <div class="detection-box"></div>
                <canvas id="debug" style="display: none;"></canvas>
            </div>

            <div class="button-container">
                <button id="capture-btn" class="action-button">ì‚¬ì§„ ì°ê¸°</button>
                <button id="retake-btn" class="action-button" style="display: none;">ë‹¤ì‹œ ì°ê¸°</button>
            </div>
        </div>

        <div class="mode-content" id="uploadContent">
            <div class="upload-instructions">
                <h2>ì‚¬ì§„ ì—…ë¡œë“œ ë°©ë²•</h2>
                <p>ë§ŒëŠ¥ì‹œí—˜ì§€ê°€ ì˜ ë³´ì´ëŠ” ì‚¬ì§„ì„ ì„ íƒí•´ì£¼ì„¸ìš”</p>
            </div>

            <div class="upload-area" id="uploadArea">
                <i>ğŸ“</i>
                <p>ì‚¬ì§„ì„ ì—¬ê¸°ì— ëŒì–´ë‹¤ ë†“ê±°ë‚˜</p>
                <p>ì•„ë˜ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ì„ íƒí•˜ì„¸ìš”</p>
                <input type="file" id="file-input" accept="image/*" style="display: none;">
        </div>

        <div class="button-container">
                <button id="upload-btn" class="action-button">ì‚¬ì§„ ì„ íƒ</button>
            </div>
        </div>

        <div class="instructions">
            <h2>ğŸ“ ì‚¬ìš© ë°©ë²•</h2>
            <ol>
                <li>ì‚¬ì§„ì„ ì°ê±°ë‚˜ ì—…ë¡œë“œí•œ í›„, ë§ŒëŠ¥ì‹œí—˜ì§€ê°€ ì˜ ë³´ì´ëŠ” ì‚¬ì§„ì´ í‘œì‹œë©ë‹ˆë‹¤.</li>
                <li>ë§ˆìš°ìŠ¤ë¡œ ë“œë˜ê·¸í•˜ì—¬ <span class="highlight">ì‹œí—˜ì§€ ì˜ì—­ì„ ì„ íƒ</span>í•´ì£¼ì„¸ìš”.</li>
                <li>ì„ íƒí•œ ì˜ì—­ì˜ ëª¨ì„œë¦¬ë¥¼ ë“œë˜ê·¸í•˜ì—¬ <span class="highlight">í¬ê¸°ì™€ ìœ„ì¹˜ë¥¼ ì¡°ì •</span>í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
                <li>ì‹œí—˜ì§€ ì˜ì—­ì´ ì •í™•í•˜ê²Œ ì„ íƒë˜ë©´ <span class="highlight">"ì´ë¯¸ì§€ ì²˜ë¦¬í•˜ê¸°"</span> ë²„íŠ¼ì„ í´ë¦­í•´ì£¼ì„¸ìš”.</li>
                <li>ì²˜ë¦¬ê°€ ì™„ë£Œë˜ë©´ ìë™ìœ¼ë¡œ ë‹¤ìŒ ë‹¨ê³„ë¡œ ì´ë™í•©ë‹ˆë‹¤.</li>
            </ol>
        </div>

        <div class="preview-container" id="previewContainer">
            <div class="zoom-controls">
                <button class="zoom-button" id="zoomIn">+</button>
                <button class="zoom-button" id="zoomOut">-</button>
            </div>
            <img id="previewImage" class="preview-image">
            <div class="selection-box" id="selectionBox">
                <div class="selection-handle top-left"></div>
                <div class="selection-handle top-right"></div>
                <div class="selection-handle bottom-left"></div>
                <div class="selection-handle bottom-right"></div>
            </div>
            <div class="preview-controls">
                <button id="processImage" class="preview-button" disabled>ì´ë¯¸ì§€ ì²˜ë¦¬í•˜ê¸°</button>
                <button id="cancelPreview" class="preview-button">ì·¨ì†Œ</button>
            </div>
        </div>

        <div id="status" class="status-message"></div>
        <div class="progress-container" id="progressContainer">
            <div class="progress-bar" id="progressBar"></div>
            <div class="progress-text" id="progressText">ì²˜ë¦¬ ì¤‘: 0%</div>
            <div class="time-estimate" id="timeEstimate">ì˜ˆìƒ ì†Œìš”ì‹œê°„: 2-3ì´ˆ</div>
        </div>

        <div class="navigation-buttons">
            <button onclick="location.href='index.html'" class="nav-button">í™œë™ì˜ ì²˜ìŒìœ¼ë¡œ</button>
            <button id="next-btn" onclick="location.href='measurement.html'" class="nav-button" disabled>ë‹¤ìŒìœ¼ë¡œ</button>
        </div>
    </div>

    <script>
        let stream = null;
        let capturedImage = null;
        let opencvReady = false;
        let currentZoom = 1.0;
        let isSelecting = false;
        let isResizing = false;
        let startX, startY;
        let selectionBox = document.getElementById('selectionBox');
        let previewImage = document.getElementById('previewImage');
        let processButton = document.getElementById('processImage');
        let handles = selectionBox.querySelectorAll('.selection-handle');
        let currentHandle = null;

        // OpenCV.js ë¡œë“œ ìƒíƒœ í™•ì¸
        function onOpenCVReady() {
            opencvReady = true;
            console.log('OpenCV.jsê°€ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤.');
        }

        // OpenCV.js ë¡œë“œ ì‹¤íŒ¨ ì²˜ë¦¬
        function onOpenCVError() {
            console.error('OpenCV.js ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            alert('ì´ë¯¸ì§€ ì²˜ë¦¬ë¥¼ ìœ„í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
        }

        // OpenCV.js ì´ˆê¸°í™”
        window.onload = function() {
            cv['onRuntimeInitialized'] = onOpenCVReady;
            cv['onError'] = onOpenCVError;
        };

        // ì¹´ë©”ë¼ ì ‘ê·¼
        async function startCamera() {
            try {
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('ì¹´ë©”ë¼ ì ‘ê·¼ì´ ì§€ì›ë˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.');
                }

                const constraints = {
                    video: {
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        facingMode: 'environment'
                    }
                };

                stream = await navigator.mediaDevices.getUserMedia(constraints);
                const video = document.getElementById('video');
                video.srcObject = stream;
                video.play();
                
                return true;
            } catch (err) {
                console.error('ì¹´ë©”ë¼ ì ‘ê·¼ ì˜¤ë¥˜:', err);
                alert('ì¹´ë©”ë¼ì— ì ‘ê·¼í•  ìˆ˜ ì—†ì–´ìš”. ì¹´ë©”ë¼ ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”!');
                return false;
            }
        }

        // ë§ŒëŠ¥ì‹œí—˜ì§€ ì¸ì‹ í•¨ìˆ˜
        async function detectPaper(imageData, selection = null) {
            if (!opencvReady) {
                alert('ì´ë¯¸ì§€ ì²˜ë¦¬ë¥¼ ìœ„í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ì•„ì§ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                return;
            }

            const startTime = performance.now();
            let img = null;
            let resized = null;
            let roi = null;

            try {
                const progressContainer = document.getElementById('progressContainer');
                const progressBar = document.getElementById('progressBar');
                const progressText = document.getElementById('progressText');
                const timeEstimate = document.getElementById('timeEstimate');
                
                progressContainer.style.display = 'block';
                progressBar.style.width = '10%';
                progressText.textContent = 'ì²˜ë¦¬ ì¤‘: 10%';
                timeEstimate.textContent = 'ì˜ˆìƒ ì†Œìš”ì‹œê°„: 1-2ì´ˆ';
                
                // ì´ë¯¸ì§€ ë¡œë“œ
                img = await new Promise((resolve, reject) => {
                    let imgElement = new Image();
                    imgElement.onload = () => {
                        try {
                            let mat = cv.imread(imgElement);
                            resolve(mat);
                        } catch (error) {
                            reject(error);
                        }
                    };
                    imgElement.onerror = reject;
                    imgElement.src = imageData;
                });

                if (!img || img.empty()) {
                    throw new Error('ì´ë¯¸ì§€ ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }

                progressBar.style.width = '30%';
                progressText.textContent = 'ì²˜ë¦¬ ì¤‘: 30%';

                // ì´ë¯¸ì§€ í¬ê¸° ì¡°ì •
                resized = new cv.Mat();
                const targetWidth = 800;
                const targetHeight = Math.round(img.rows * (targetWidth / img.cols));
                cv.resize(img, resized, new cv.Size(targetWidth, targetHeight), 0, 0, cv.INTER_AREA);

                if (selection) {
                    // ì¢Œí‘œ ë³€í™˜ ì‹œ ì‹¤ì œ ì´ë¯¸ì§€ í¬ê¸° ì‚¬ìš©
                    const scaleX = resized.cols / previewImage.naturalWidth;
                    const scaleY = resized.rows / previewImage.naturalHeight;
                    const x = Math.floor(Math.min(selection.startX, selection.endX) * scaleX);
                    const y = Math.floor(Math.min(selection.startY, selection.endY) * scaleY);
                    const width = Math.floor(Math.abs(selection.endX - selection.startX) * scaleX);
                    const height = Math.floor(Math.abs(selection.endY - selection.startY) * scaleY);
                    // ROIê°€ ì´ë¯¸ì§€ ê²½ê³„ë¥¼ ë²—ì–´ë‚˜ì§€ ì•Šë„ë¡ ì œí•œ
                    const x1 = Math.max(0, Math.min(x, resized.cols - 1));
                    const y1 = Math.max(0, Math.min(y, resized.rows - 1));
                    const w = Math.max(1, Math.min(width, resized.cols - x1));
                    const h = Math.max(1, Math.min(height, resized.rows - y1));

                    // ROI ì¶”ì¶œ
                    const rect = new cv.Rect(x1, y1, w, h);
                    roi = resized.roi(rect);

                    // ROIì˜ í‰ê·  ìƒ‰ìƒ ê³„ì‚° (BGR)
                    const mean = cv.mean(roi); // [B, G, R, A]
                    console.log('ROI mean (BGR):', mean);

                    // BGR â†’ RGB ë³€í™˜ (canvasì™€ ì¼ì¹˜í•˜ë„ë¡)
                    const rgb = {
                        red: Math.round(mean[0]),   // B
                        green: Math.round(mean[1]), // G
                        blue: Math.round(mean[2])   // R
                    };
                    console.log('ROI mean (RGB):', rgb);

                    // ê²°ê³¼ ì €ì¥
                    const results = [{
                        index: 1,
                        rgb: rgb,
                        position: { x: x1, y: y1, width: w, height: h }
                    }];
                    localStorage.setItem('phResults', JSON.stringify(results));

                    // ë””ë²„ê·¸ ì´ë¯¸ì§€ ì €ì¥ (BGR â†’ RGB ë³€í™˜ í›„ ì €ì¥)
                    let canvas = document.createElement('canvas');
                    canvas.width = resized.cols;
                    canvas.height = resized.rows;
                    let rgbMat = new cv.Mat();
                    cv.cvtColor(resized, rgbMat, cv.COLOR_BGR2RGB);
                    cv.imshow(canvas, rgbMat);
                    rgbMat.delete();
                    localStorage.setItem('phImage', canvas.toDataURL('image/jpeg'));
                    
                    // ROI ì´ë¯¸ì§€ë¥¼ ë³„ë„ë¡œ ì €ì¥
                    let roiCanvas = document.createElement('canvas');
                    roiCanvas.width = w;
                    roiCanvas.height = h;
                    let roiCtx = roiCanvas.getContext('2d');
                    let roiRgbMat = new cv.Mat();
                    cv.cvtColor(roi, roiRgbMat, cv.COLOR_BGR2RGB);
                    cv.imshow(roiCanvas, roiRgbMat);
                    roiRgbMat.delete();
                    localStorage.setItem('phRoiImage', roiCanvas.toDataURL('image/jpeg'));
                    
                    const endTime = performance.now();
                    const processingTime = ((endTime - startTime) / 1000).toFixed(2);
                    
                    progressBar.style.width = '100%';
                    progressText.textContent = 'ì²˜ë¦¬ ì™„ë£Œ!';
                    timeEstimate.textContent = `ì‹¤ì œ ì†Œìš”ì‹œê°„: ${processingTime}ì´ˆ`;
                    
                    setTimeout(() => {
                        progressContainer.style.display = 'none';
                        document.getElementById('status').textContent = 'ì‹œí—˜ì§€ê°€ ì„±ê³µì ìœ¼ë¡œ ë¶„ì„ë˜ì—ˆìŠµë‹ˆë‹¤!';
                        document.getElementById('next-btn').disabled = false;
                    }, 500);
                    
                } else {
                    progressContainer.style.display = 'none';
                    document.getElementById('status').textContent = 'ì‹œí—˜ì§€ ì˜ì—­ì„ ì„ íƒí•´ì£¼ì„¸ìš”!';
                    document.getElementById('next-btn').disabled = true;
                }
                
            } catch (err) {
                console.error('ì´ë¯¸ì§€ ì²˜ë¦¬ ì˜¤ë¥˜:', err);
                document.getElementById('status').textContent = 'ì´ë¯¸ì§€ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
                document.getElementById('progressContainer').style.display = 'none';
                alert('ì´ë¯¸ì§€ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            } finally {
                // ë©”ëª¨ë¦¬ í•´ì œ
                if (img) img.delete();
                if (resized) resized.delete();
                if (roi) roi.delete();
            }
        }

        // ëª¨ë“œ ì „í™˜ ì²˜ë¦¬
        document.getElementById('cameraMode').addEventListener('click', () => {
            document.getElementById('cameraMode').classList.add('active');
            document.getElementById('uploadMode').classList.remove('active');
            document.getElementById('cameraContent').classList.add('active');
            document.getElementById('uploadContent').classList.remove('active');
            startCamera();
        });

        document.getElementById('uploadMode').addEventListener('click', () => {
            document.getElementById('uploadMode').classList.add('active');
            document.getElementById('cameraMode').classList.remove('active');
            document.getElementById('uploadContent').classList.add('active');
            document.getElementById('cameraContent').classList.remove('active');
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
        });

        // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì²˜ë¦¬
        const uploadArea = document.getElementById('uploadArea');
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.style.background = '#e3f2fd';
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.style.background = '';
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.style.background = '';
            const file = e.dataTransfer.files[0];
            if (file) {
                handleFile(file);
            }
        });

        function handleFile(file) {
            if (file.size > 5 * 1024 * 1024) {
                alert('íŒŒì¼ í¬ê¸°ëŠ” 5MBë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            if (!file.type.match('image.*')) {
                alert('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                const previewImage = document.getElementById('previewImage');
                previewImage.src = e.target.result;
                document.getElementById('previewContainer').style.display = 'block';
                document.getElementById('uploadContent').style.display = 'none';
                // ì›ë³¸ ì´ë¯¸ì§€ ì €ì¥
                localStorage.setItem('phOriginalImage', e.target.result);
                console.log('ì—…ë¡œë“œ ì›ë³¸ ì €ì¥:', e.target.result.slice(0, 100));
            };
            reader.readAsDataURL(file);
        }

        // ì‚¬ì§„ ì´¬ì˜
        document.getElementById('capture-btn').addEventListener('click', async () => {
            try {
                const video = document.getElementById('video');
                const canvas = document.getElementById('canvas');
                const capturedImage = document.getElementById('captured-image');
                const previewImage = document.getElementById('previewImage');
                const previewContainer = document.getElementById('previewContainer');
                
                if (!video.videoWidth || !video.videoHeight) {
                    throw new Error('ì¹´ë©”ë¼ê°€ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                }

                // ìº”ë²„ìŠ¤ í¬ê¸° ì„¤ì •
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                
                // ë¹„ë””ì˜¤ í”„ë ˆì„ì„ ìº”ë²„ìŠ¤ì— ê·¸ë¦¬ê¸°
                const context = canvas.getContext('2d');
                context.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                // ìº¡ì²˜ëœ ì´ë¯¸ì§€ í‘œì‹œ
                const imageData = canvas.toDataURL('image/jpeg');
                capturedImage.src = imageData;
                previewImage.src = imageData;
                
                // ì›ë³¸ ì´ë¯¸ì§€ ì €ì¥
                localStorage.setItem('phOriginalImage', imageData);
                console.log('ì´¬ì˜ ì›ë³¸ ì €ì¥:', imageData.slice(0, 100));
                
                // ë¯¸ë¦¬ë³´ê¸° ì»¨í…Œì´ë„ˆ í‘œì‹œ
                previewContainer.style.display = 'block';
                video.style.display = 'none';
                capturedImage.style.display = 'none';
                
                // ë²„íŠ¼ ìƒíƒœ ë³€ê²½
                document.getElementById('capture-btn').style.display = 'none';
                document.getElementById('retake-btn').style.display = 'inline-block';
                
                // ì„ íƒ ì˜ì—­ ì´ˆê¸°í™”
                resetSelection();
                
            } catch (error) {
                console.error('ì‚¬ì§„ ì´¬ì˜ ì˜¤ë¥˜:', error);
                alert('ì‚¬ì§„ ì´¬ì˜ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            }
        });

        // ë‹¤ì‹œ ì°ê¸°
        document.getElementById('retake-btn').addEventListener('click', async () => {
            try {
                const video = document.getElementById('video');
                const previewContainer = document.getElementById('previewContainer');
                
                // ë¹„ë””ì˜¤ ìŠ¤íŠ¸ë¦¼ ì¬ì‹œì‘
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                }
                
                const success = await startCamera();
                if (success) {
                    video.style.display = 'block';
                    previewContainer.style.display = 'none';
                    
                    document.getElementById('capture-btn').style.display = 'inline-block';
                    document.getElementById('retake-btn').style.display = 'none';
                    document.getElementById('next-btn').disabled = true;
            document.getElementById('status').textContent = '';
                }
            } catch (error) {
                console.error('ì¹´ë©”ë¼ ì¬ì‹œì‘ ì˜¤ë¥˜:', error);
                alert('ì¹´ë©”ë¼ ì¬ì‹œì‘ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
            }
        });

        // ì‚¬ì§„ ì—…ë¡œë“œ
        document.getElementById('upload-btn').addEventListener('click', () => {
            document.getElementById('file-input').click();
        });

        document.getElementById('file-input').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (file) {
                // íŒŒì¼ í¬ê¸° ì œí•œ (5MB)
                if (file.size > 5 * 1024 * 1024) {
                    alert('íŒŒì¼ í¬ê¸°ëŠ” 5MBë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }

                // íŒŒì¼ í˜•ì‹ ê²€ì‚¬
                if (!file.type.match('image.*')) {
                    alert('ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                    return;
                }

                try {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        // ë¯¸ë¦¬ë³´ê¸° í‘œì‹œ
                        const previewImage = document.getElementById('previewImage');
                        previewImage.src = e.target.result;
                        document.getElementById('previewContainer').style.display = 'block';
                        
                        // ì¹´ë©”ë¼ í™”ë©´ ìˆ¨ê¹€
                        document.getElementById('video').style.display = 'none';
                        document.getElementById('capture-btn').style.display = 'none';
                        document.getElementById('retake-btn').style.display = 'none';
                    };
                    reader.readAsDataURL(file);
                } catch (error) {
                    console.error('ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ì˜¤ë¥˜:', error);
                    alert('ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            }
        });

        // ì„ íƒ ì˜ì—­ ì´ˆê¸°í™”
        function resetSelection() {
            selectionBox.style.display = 'none';
            selectionBox.style.left = '0px';
            selectionBox.style.top = '0px';
            selectionBox.style.width = '0px';
            selectionBox.style.height = '0px';
            processButton.disabled = true;
        }

        // ì„ íƒ ì˜ì—­ ì—…ë°ì´íŠ¸
        function updateSelection(x, y, width, height) {
            // ì´ë¯¸ì§€ ê²½ê³„ ë‚´ì—ì„œë§Œ ì„ íƒ ê°€ëŠ¥í•˜ë„ë¡ ì œí•œ
            const rect = previewImage.getBoundingClientRect();
            x = Math.max(0, Math.min(x, rect.width - width));
            y = Math.max(0, Math.min(y, rect.height - height));
            
            selectionBox.style.left = x + 'px';
            selectionBox.style.top = y + 'px';
            selectionBox.style.width = width + 'px';
            selectionBox.style.height = height + 'px';
            
            // ìµœì†Œ í¬ê¸° ì²´í¬ (10x10 í”½ì…€ë¡œ ë³€ê²½)
            if (width > 10 && height > 10) {
                processButton.disabled = false;
            } else {
                processButton.disabled = true;
            }
        }

        // í•¸ë“¤ ì´ë²¤íŠ¸ ì²˜ë¦¬
        handles.forEach(handle => {
            handle.addEventListener('mousedown', (e) => {
                e.stopPropagation();
                isResizing = true;
                currentHandle = handle;
                startX = e.clientX;
                startY = e.clientY;
            });
        });

        // í™•ëŒ€/ì¶•ì†Œ ê¸°ëŠ¥
        function updateZoom() {
            previewImage.style.transform = `scale(${currentZoom})`;
            previewImage.style.transformOrigin = 'top left';
        }

        const zoomInBtn = document.getElementById('zoomIn');
        const zoomOutBtn = document.getElementById('zoomOut');

        zoomInBtn.addEventListener('click', () => {
            currentZoom = Math.min(2.0, currentZoom + 0.1);
            updateZoom();
        });

        zoomOutBtn.addEventListener('click', () => {
            currentZoom = Math.max(1.0, currentZoom - 0.1);
            updateZoom();
        });

        // ì´ë¯¸ì§€ ì„ íƒ ì´ë²¤íŠ¸
        previewImage.addEventListener('mousedown', (e) => {
            if (e.target !== previewImage) return;
            
            isSelecting = true;
            const rect = previewImage.getBoundingClientRect();
            startX = (e.clientX - rect.left) / currentZoom;
            startY = (e.clientY - rect.top) / currentZoom;
            
            selectionBox.style.display = 'block';
            updateSelection(startX, startY, 0, 0);
        });

        // ë§ˆìš°ìŠ¤ ì´ë™ ì´ë²¤íŠ¸
        document.addEventListener('mousemove', (e) => {
            if (!isSelecting && !isResizing) return;
            
            const rect = previewImage.getBoundingClientRect();
            const currentX = (e.clientX - rect.left) / currentZoom;
            const currentY = (e.clientY - rect.top) / currentZoom;
            
            if (isResizing && currentHandle) {
                const handleClass = currentHandle.className;
                let x = parseInt(selectionBox.style.left);
                let y = parseInt(selectionBox.style.top);
                let width = parseInt(selectionBox.style.width);
                let height = parseInt(selectionBox.style.height);
                
                if (handleClass.includes('top-left')) {
                    width += x - currentX;
                    height += y - currentY;
                    x = currentX;
                    y = currentY;
                } else if (handleClass.includes('top-right')) {
                    width = currentX - x;
                    height += y - currentY;
                    y = currentY;
                } else if (handleClass.includes('bottom-left')) {
                    width += x - currentX;
                    height = currentY - y;
                    x = currentX;
                } else if (handleClass.includes('bottom-right')) {
                    width = currentX - x;
                    height = currentY - y;
                }
                
                width = Math.max(10, width);
                height = Math.max(10, height);
                
                updateSelection(x, y, width, height);
            } else if (isSelecting) {
                const width = currentX - startX;
                const height = currentY - startY;
                updateSelection(startX, startY, width, height);
            }
        });

        // ë§ˆìš°ìŠ¤ ì—… ì´ë²¤íŠ¸
        document.addEventListener('mouseup', () => {
            isSelecting = false;
            isResizing = false;
            currentHandle = null;
        });

        // ì´ë¯¸ì§€ ì²˜ë¦¬ ë²„íŠ¼ ì´ë²¤íŠ¸
        document.getElementById('processImage').addEventListener('click', async () => {
            const previewImage = document.getElementById('previewImage');
            if (!previewImage.src) {
                alert('ì²˜ë¦¬í•  ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const selectionBox = document.getElementById('selectionBox');
            if (!selectionBox.style.display || selectionBox.style.display === 'none') {
                alert('ì‹œí—˜ì§€ ì˜ì—­ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            const selection = {
                startX: parseInt(selectionBox.style.left),
                startY: parseInt(selectionBox.style.top),
                endX: parseInt(selectionBox.style.left) + parseInt(selectionBox.style.width),
                endY: parseInt(selectionBox.style.top) + parseInt(selectionBox.style.height)
            };

            try {
                document.getElementById('progressContainer').style.display = 'block';
                document.getElementById('previewContainer').style.display = 'none';
                await detectPaper(previewImage.src, selection);
            } catch (error) {
                console.error('ì´ë¯¸ì§€ ì²˜ë¦¬ ì˜¤ë¥˜:', error);
                alert('ì´ë¯¸ì§€ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            }
        });

        // ì·¨ì†Œ ë²„íŠ¼ ì´ë²¤íŠ¸
        document.getElementById('cancelPreview').addEventListener('click', () => {
            resetSelection();
            document.getElementById('previewContainer').style.display = 'none';
            document.getElementById('video').style.display = 'block';
            document.getElementById('capture-btn').style.display = 'inline-block';
            document.getElementById('file-input').value = '';
        });

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì¹´ë©”ë¼ ì‹œì‘
        window.addEventListener('load', async () => {
            try {
                const success = await startCamera();
                if (!success) {
                    document.getElementById('capture-btn').disabled = true;
                }
            } catch (error) {
                console.error('í˜ì´ì§€ ë¡œë“œ ì˜¤ë¥˜:', error);
                alert('ì¹´ë©”ë¼ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
            }
        });

        // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ë¦¬ì†ŒìŠ¤ ì •ë¦¬
        window.addEventListener('beforeunload', () => {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
            }
        });
    </script>
</body>
</html> 