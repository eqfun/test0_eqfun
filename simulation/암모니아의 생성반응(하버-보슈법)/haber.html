<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>í•˜ë²„-ë³´ìŠˆë²• ì‹œë®¬ë ˆì´í„°</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.1.0/dist/chartjs-plugin-annotation.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary-color: #4CAF50;
      --secondary-color: #2196F3;
      --accent-color: #FF9800;
      --background-color: #f5f5f5;
      --card-color: #ffffff;
      --text-color: #333333;
    }

    body {
      font-family: 'Noto Sans KR', sans-serif;
      padding: 20px;
      background: var(--background-color);
      color: var(--text-color);
      line-height: 1.6;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      margin-bottom: 40px;
      padding: 20px;
      background: var(--card-color);
      border-radius: 15px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .header h1 {
      color: var(--primary-color);
      font-size: 2.2em;
      margin-bottom: 10px;
    }

    .header p {
      color: var(--text-color);
      font-size: 1.1em;
    }

    .section {
      background: var(--card-color);
      padding: 25px;
      margin-bottom: 30px;
      border-radius: 15px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }

    .section h2 {
      color: var(--secondary-color);
      font-size: 1.5em;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .section h2::before {
      content: "âš—ï¸";
      font-size: 1.2em;
    }

    .reaction-equation {
      text-align: center;
      font-size: 1.4em;
      margin: 20px 0;
      padding: 15px;
      background-color: #e8f5e9;
      border-radius: 10px;
      color: var(--primary-color);
      font-weight: bold;
    }

    .inputs {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
    }

    .input-group {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 10px;
      border-left: 4px solid var(--secondary-color);
    }

    .input-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: var(--text-color);
    }

    .input-group input, .input-group select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 1em;
    }

    .input-group .help-text {
      font-size: 0.85em;
      color: #666;
      margin-top: 5px;
    }

    .button-group {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin: 20px 0;
    }

    button {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 1em;
      cursor: pointer;
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    button.primary {
      background: var(--primary-color);
      color: white;
    }

    button.secondary {
      background: var(--secondary-color);
      color: white;
    }

    button.danger {
      background: #f44336;
      color: white;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    .chart-container {
      position: relative;
      height: 400px;
      width: 100%;
      margin: 30px auto;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .result-box {
      background: #e3f2fd;
      padding: 20px;
      border-radius: 10px;
      margin-top: 20px;
    }

    .result-box h3 {
      color: var(--secondary-color);
      margin-top: 0;
    }

    .result-value {
      font-size: 1.2em;
      font-weight: bold;
      color: var(--primary-color);
    }

    @media (max-width: 768px) {
      .inputs {
        grid-template-columns: 1fr;
      }
    }

    .guide-section {
      background: #fff3e0;
      padding: 25px;
      border-radius: 15px;
      margin-bottom: 30px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .guide-section h2 {
      color: #ff9800;
      margin-top: 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .guide-section h2::before {
      content: "ğŸ“š";
    }

    .guide-step {
      margin-bottom: 20px;
      padding: 15px;
      background: white;
      border-radius: 10px;
      border-left: 4px solid #ff9800;
    }

    .guide-step h3 {
      color: #ff9800;
      margin-top: 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .guide-step p {
      margin: 10px 0;
      color: #666;
    }

    .tip-box {
      background: #e8f5e9;
      padding: 15px;
      border-radius: 10px;
      margin: 15px 0;
      border-left: 4px solid #4CAF50;
    }

    .tip-box::before {
      content: "ğŸ’¡";
      margin-right: 8px;
      color: #4CAF50;
    }

    .result-guide {
      background: #e3f2fd;
      padding: 15px;
      border-radius: 10px;
      margin-top: 20px;
    }

    .result-guide h3 {
      color: #2196F3;
      margin-top: 0;
    }

    .result-guide ul {
      padding-left: 20px;
    }

    .result-guide li {
      margin: 8px 0;
    }

    .history-section {
      background: #f5f5f5;
      padding: 25px;
      border-radius: 15px;
      margin-bottom: 30px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .history-section h2 {
      color: #795548;
      margin-top: 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .history-section h2::before {
      content: "ğŸ“œ";
    }

    .history-content {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .history-card {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .history-card h3 {
      color: #795548;
      margin-top: 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .history-card p {
      color: #666;
      line-height: 1.6;
    }

    .simulator-section {
      margin-top: 40px;
    }

    .complete-btn {
      background-color: #4CAF50;
      color: white;
      border: none;
      padding: 10px 20px;
      text-align: center;
      text-decoration: none;
      display: inline-block;
      font-size: 16px;
      margin: 4px 2px;
      cursor: pointer;
      border-radius: 5px;
      transition: background-color 0.3s;
    }

    .complete-btn:hover {
      background-color: #45a049;
    }

    .complete-btn:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }

    /* ì²˜ìŒìœ¼ë¡œ ëŒì•„ê°€ëŠ” ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .home-button {
      position: fixed;
      top: 20px;
      left: 20px;
      padding: 12px 24px;
      background-color: #FF8A65;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
      transition: all 0.3s ease;
      z-index: 1000;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .home-button:hover {
      background-color: #FF7043;
      transform: translateY(-3px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.3);
    }

    .home-button:active {
      transform: translateY(0);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }
  </style>
</head>
<body>
  <!-- ì²˜ìŒìœ¼ë¡œ ëŒì•„ê°€ëŠ” ë²„íŠ¼ -->
  <button class="home-button" onclick="window.location.href='../../index.html'">
    ğŸ  ì²˜ìŒìœ¼ë¡œ
  </button>

  <div class="container">
    <div class="header">
      <h1>âš—ï¸ í•˜ë²„-ë³´ìŠˆë²• ì‹œë®¬ë ˆì´í„°</h1>
      <p>ì•”ëª¨ë‹ˆì•„ í•©ì„± ë°˜ì‘ì„ ì‹œë®¬ë ˆì´ì…˜í•´ë³´ì„¸ìš”!</p>
    </div>

    <!-- ì—­ì‚¬ì  ì˜ë¯¸ ì„¹ì…˜ ì¶”ê°€ -->
    <div class="history-section">
      <h2>í•˜ë²„-ë³´ìŠˆë²•ì˜ ì—­ì‚¬ì  ì˜ë¯¸</h2>
      <div class="history-content">
        <div class="history-card">
          <h3>ğŸŒ ì¸ë¥˜ì‚¬ì˜ í˜ëª…</h3>
          <p>í•˜ë²„-ë³´ìŠˆë²•ì€ 20ì„¸ê¸° ì´ˆ í”„ë¦¬ì¸  í•˜ë²„ì™€ ì¹´ë¥¼ ë³´ìŠˆì— ì˜í•´ ê°œë°œëœ ì•”ëª¨ë‹ˆì•„ í•©ì„± ê³µì •ì…ë‹ˆë‹¤. ì´ ê³µì •ì€ ì¸ë¥˜ ì—­ì‚¬ìƒ ê°€ì¥ ì¤‘ìš”í•œ í™”í•™ ê³µì • ì¤‘ í•˜ë‚˜ë¡œ ê¼½í™ë‹ˆë‹¤.</p>
        </div>
        <div class="history-card">
          <h3>ğŸŒ± ì‹ëŸ‰ ìƒì‚°ì˜ í˜ì‹ </h3>
          <p>ì´ ê³µì •ì˜ ê°œë°œë¡œ ëŒ€ëŸ‰ì˜ ì•”ëª¨ë‹ˆì•„ë¥¼ í•©ì„±í•  ìˆ˜ ìˆê²Œ ë˜ì—ˆê³ , ì´ë¥¼ í†µí•´ ì§ˆì†Œ ë¹„ë£Œë¥¼ ëŒ€ëŸ‰ ìƒì‚°í•  ìˆ˜ ìˆê²Œ ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ëŠ” ì „ ì„¸ê³„ì ì¸ ì‹ëŸ‰ ìƒì‚° ì¦ê°€ì— í¬ê²Œ ê¸°ì—¬í–ˆìŠµë‹ˆë‹¤.</p>
        </div>
        <div class="history-card">
          <h3>ğŸ­ í˜„ëŒ€ ì‚°ì—…ì˜ ê¸°ë°˜</h3>
          <p>ì˜¤ëŠ˜ë‚ ì—ë„ ì´ ê³µì •ì€ ì „ ì„¸ê³„ ì•”ëª¨ë‹ˆì•„ ìƒì‚°ì˜ 80% ì´ìƒì„ ì°¨ì§€í•˜ë©°, ë¹„ë£Œ, í”Œë¼ìŠ¤í‹±, ì˜ì•½í’ˆ ë“± ë‹¤ì–‘í•œ ì‚°ì—…ì˜ ê¸°ë°˜ì´ ë˜ê³  ìˆìŠµë‹ˆë‹¤.</p>
        </div>
      </div>
    </div>

    <!-- ê¸°ë³¸ ê°œë… ì„¤ëª…ê³¼ 1ì°¨ ì‹œë®¬ë ˆì´í„° -->
    <div class="guide-section">
      <h2>1ï¸âƒ£ ê¸°ë³¸ ê°œë… ì´í•´í•˜ê¸°</h2>
      <div class="guide-step">
        <h3>í•˜ë²„-ë³´ìŠˆë²•ì´ë€?</h3>
        <p>í•˜ë²„-ë³´ìŠˆë²•ì€ ì§ˆì†Œ(Nâ‚‚)ì™€ ìˆ˜ì†Œ(Hâ‚‚)ë¥¼ ë°˜ì‘ì‹œì¼œ ì•”ëª¨ë‹ˆì•„(NHâ‚ƒ)ë¥¼ ë§Œë“œëŠ” ê³µì •ì…ë‹ˆë‹¤.</p>
        <p class="reaction-equation">Nâ‚‚ (g) + 3Hâ‚‚ (g) â‡Œ 2NHâ‚ƒ (g)</p>
        <div class="tip-box">
          ì´ ë°˜ì‘ì€ ê°€ì—­ë°˜ì‘ìœ¼ë¡œ, ë°˜ì‘ë¬¼ê³¼ ìƒì„±ë¬¼ì´ í‰í˜•ì„ ì´ë£¨ê²Œ ë©ë‹ˆë‹¤.
        </div>
      </div>
    </div>

    <div class="simulator-section">
      <div class="section">
        <h2>ê¸°ë³¸ ë°˜ì‘ ì‹œë®¬ë ˆì´ì…˜</h2>
        <div class="inputs">
          <div class="input-group">
            <label>Nâ‚‚ ë†ë„ (mol/L)</label>
            <input id="n2_1" type="number" value="1.0" step="0.1" />
            <div class="help-text">ì§ˆì†Œ ê¸°ì²´ì˜ ì´ˆê¸° ë†ë„ì…ë‹ˆë‹¤</div>
          </div>
          <div class="input-group">
            <label>Hâ‚‚ ë†ë„ (mol/L)</label>
            <input id="h2_1" type="number" value="3.0" step="0.1" />
            <div class="help-text">ìˆ˜ì†Œ ê¸°ì²´ì˜ ì´ˆê¸° ë†ë„ì…ë‹ˆë‹¤</div>
          </div>
          <div class="input-group">
            <label>ì••ë ¥ (bar)</label>
            <input id="pressure_1" type="number" value="200.0" step="0.1" />
            <div class="help-text">ë°˜ì‘ ìš©ê¸°ì˜ ì••ë ¥ì…ë‹ˆë‹¤</div>
          </div>
          <div class="input-group">
            <label>ì˜¨ë„ (K)</label>
            <input id="temp_1" type="number" value="700" step="10" />
            <div class="help-text">ë°˜ì‘ ìš©ê¸°ì˜ ì˜¨ë„ì…ë‹ˆë‹¤</div>
          </div>
          <div class="input-group">
            <label>ë°˜ì‘ ì‹œê°„ (ì‹œê°„)</label>
            <input id="time_1" type="number" value="100" step="0.5" />
            <div class="help-text">ë°˜ì‘ì„ ì§„í–‰í•˜ëŠ” ì‹œê°„ì…ë‹ˆë‹¤</div>
          </div>
          <div class="input-group">
            <label>ì´‰ë§¤ ì„ íƒ</label>
            <select id="catalyst_1">
              <option value="none">ì´‰ë§¤ ì—†ìŒ</option>
              <option value="positive">ì •ì´‰ë§¤</option>
              <option value="negative">ë¶€ì´‰ë§¤</option>
            </select>
            <div class="help-text">ë°˜ì‘ ì†ë„ë¥¼ ë³€í™”ì‹œí‚¤ëŠ” ì´‰ë§¤ì…ë‹ˆë‹¤</div>
          </div>
        </div>
        <div class="button-group">
          <button class="primary" onclick="simulate1()">â–¶ï¸ ì‹œë®¬ë ˆì´ì…˜ ì‹¤í–‰</button>
          <button class="secondary" onclick="downloadCSV(lastResult1, 'simulation1.csv')">ğŸ“¥ ê²°ê³¼ ì €ì¥</button>
          <button class="danger" onclick="reset1()">ğŸ”„ ì´ˆê¸°í™”</button>
          <button class="complete-btn" onclick="completeActivity()">í•™ìŠµ ì™„ë£Œ</button>
        </div>
        <div class="chart-container">
          <canvas id="chart1"></canvas>
        </div>
        <div class="result-box" id="result1">
          <div class="result-guide">
            <h3>ğŸ“Š ê²°ê³¼ í•´ì„ ê°€ì´ë“œ</h3>
            <ul>
              <li>ê·¸ë˜í”„ì˜ ê° ì„ ì€ Nâ‚‚(íŒŒë€ìƒ‰), Hâ‚‚(ì´ˆë¡ìƒ‰), NHâ‚ƒ(ì£¼í™©ìƒ‰)ì˜ ë†ë„ë¥¼ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.</li>
              <li>í‰í˜• ë„ë‹¬ ì§€ì ì€ ë¹¨ê°„ ì ì„ ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤.</li>
              <li>K<sub>eq</sub>ëŠ” í‰í˜• ìƒìˆ˜ë¡œ, ë°˜ì‘ì˜ ì§„í–‰ ë°©í–¥ì„ ë‚˜íƒ€ëƒ…ë‹ˆë‹¤.</li>
              <li>ë†ë„ëŠ” mol/L ë‹¨ìœ„ë¡œ í‘œì‹œë©ë‹ˆë‹¤.</li>
            </ul>
          </div>
        </div>
      </div>
    </div>

    <!-- í‰í˜• ì´ë™ ì„¤ëª…ê³¼ 2ì°¨ ì‹œë®¬ë ˆì´í„° -->
    <div class="guide-section">
      <h2>2ï¸âƒ£ í‰í˜• ì´ë™ ì‹¤í—˜</h2>
      <div class="guide-step">
        <h3>í‰í˜• ì´ë™ì´ë€?</h3>
        <p>í™”í•™ í‰í˜• ìƒíƒœì—ì„œ ë°˜ì‘ ì¡°ê±´(ë†ë„, ì••ë ¥, ì˜¨ë„)ì„ ë³€í™”ì‹œí‚¤ë©´, ë°˜ì‘ì´ ìƒˆë¡œìš´ í‰í˜• ìƒíƒœë¡œ ì´ë™í•˜ëŠ” í˜„ìƒì„ ë§í•©ë‹ˆë‹¤.</p>
        <div class="tip-box">
          ë¥´ìƒ¤í‹€ë¦¬ì—ì˜ ì›ë¦¬ë¥¼ ê¸°ì–µí•˜ì„¸ìš”: í‰í˜• ìƒíƒœì˜ ë°˜ì‘ì— ë³€í™”ë¥¼ ê°€í•˜ë©´, ê·¸ ë³€í™”ë¥¼ ê°ì†Œì‹œí‚¤ëŠ” ë°©í–¥ìœ¼ë¡œ ë°˜ì‘ì´ ì§„í–‰ë©ë‹ˆë‹¤.
        </div>
      </div>
    </div>

    <div class="simulator-section">
      <div class="section">
        <h2>í‰í˜• ì´ë™ ì‹œë®¬ë ˆì´ì…˜</h2>
        <div class="inputs">
          <div class="input-group">
            <label>ì¶”ê°€ Nâ‚‚ (mol/L)</label>
            <input id="n2_add" type="number" value="0.0" step="0.1" />
            <div class="help-text">ì¶”ê°€ë¡œ ë„£ëŠ” ì§ˆì†Œ ê¸°ì²´ì˜ ì–‘ì…ë‹ˆë‹¤</div>
          </div>
          <div class="input-group">
            <label>ì¶”ê°€ Hâ‚‚ (mol/L)</label>
            <input id="h2_add" type="number" value="0.0" step="0.1" />
            <div class="help-text">ì¶”ê°€ë¡œ ë„£ëŠ” ìˆ˜ì†Œ ê¸°ì²´ì˜ ì–‘ì…ë‹ˆë‹¤</div>
          </div>
          <div class="input-group">
            <label>ì••ë ¥ (bar)</label>
            <input id="pressure_2" type="number" value="200.0" step="0.1" />
            <div class="help-text">ìƒˆë¡œìš´ ë°˜ì‘ ìš©ê¸°ì˜ ì••ë ¥ì…ë‹ˆë‹¤</div>
          </div>
          <div class="input-group">
            <label>ì˜¨ë„ (K)</label>
            <input id="temp_2" type="number" value="700" step="10" />
            <div class="help-text">ìƒˆë¡œìš´ ë°˜ì‘ ìš©ê¸°ì˜ ì˜¨ë„ì…ë‹ˆë‹¤</div>
          </div>
          <div class="input-group">
            <label>ë°˜ì‘ ì‹œê°„ (ì‹œê°„)</label>
            <input id="time_2" type="number" value="100" step="0.5" />
            <div class="help-text">ë°˜ì‘ì„ ì§„í–‰í•˜ëŠ” ì‹œê°„ì…ë‹ˆë‹¤</div>
          </div>
          <div class="input-group">
            <label>ì´‰ë§¤ ì„ íƒ</label>
            <select id="catalyst_2">
              <option value="none">ì´‰ë§¤ ì—†ìŒ</option>
              <option value="positive">ì •ì´‰ë§¤</option>
              <option value="negative">ë¶€ì´‰ë§¤</option>
            </select>
            <div class="help-text">ìƒˆë¡œìš´ ë°˜ì‘ì—ì„œ ì‚¬ìš©í•˜ëŠ” ì´‰ë§¤ì…ë‹ˆë‹¤</div>
          </div>
        </div>
        <div class="button-group">
          <button class="primary" onclick="simulate2()">â–¶ï¸ ì‹œë®¬ë ˆì´ì…˜ ì‹¤í–‰</button>
          <button class="secondary" onclick="downloadCSV(lastResult2, 'simulation2.csv')">ğŸ“¥ ê²°ê³¼ ì €ì¥</button>
          <button class="danger" onclick="reset2()">ğŸ”„ ì´ˆê¸°í™”</button>
          <button class="complete-btn" onclick="completeActivity()">í•™ìŠµ ì™„ë£Œ</button>
        </div>
        <div class="chart-container">
          <canvas id="chart2"></canvas>
        </div>
        <div class="result-box" id="result2">
          <div class="result-guide">
            <h3>ğŸ“Š í‰í˜• ì´ë™ í•´ì„ ê°€ì´ë“œ</h3>
            <ul>
              <li>ì²« ë²ˆì§¸ ì‹¤í—˜ì˜ ê²°ê³¼ì™€ ë¹„êµí•´ë³´ì„¸ìš”.</li>
              <li>ë°˜ì‘ë¬¼ì„ ì¶”ê°€í•˜ë©´ í‰í˜•ì´ ì–´ë–»ê²Œ ì´ë™í•˜ëŠ”ì§€ ê´€ì°°í•˜ì„¸ìš”.</li>
              <li>ì••ë ¥ì´ë‚˜ ì˜¨ë„ë¥¼ ë°”ê¾¸ë©´ ë°˜ì‘ì´ ì–´ë–»ê²Œ ë³€í•˜ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.</li>
              <li>ì´‰ë§¤ê°€ ë°˜ì‘ ì†ë„ì— ë¯¸ì¹˜ëŠ” ì˜í–¥ì„ ì‚´í´ë³´ì„¸ìš”.</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
  let lastResult1 = null, lastResult2 = null;
  let final_n2 = null, final_h2 = null, final_nh3 = null;

  function getEa(type, base) {
    if (type === "positive") return base * 0.8;
    if (type === "negative") return base * 1.2;
    return base;
  }

  function simulateReaction(n2, h2, nh3, T, catalyst, hours) {
    const R = 8.314;
    const dt = hours > 100 ? 0.5 : (hours > 10 ? 0.1 : 0.05);
    const steps = Math.floor((hours * 3600) / dt);
    const A_f = 1.5e-4, A_r = 3.0e-5;
    const Ea_f = getEa(catalyst, 110000);
    const Ea_r = getEa(catalyst, 90000);
    const kf = A_f * Math.exp(-Ea_f / (R * T));
    const kr = A_r * Math.exp(-Ea_r / (R * T));

    const time = [], N2 = [], H2 = [], NH3 = [];
    let eqIndex = null;
    let lastNH3 = nh3;
    let stableCount = 0;
    let maxNH3 = 0;  // ìµœëŒ€ NH3 ë†ë„ ì¶”ì 
    let lastChangeRate = null;  // ì´ì „ ë³€í™”ìœ¨ ì €ì¥

    for (let i = 0; i <= steps; i++) {
      const t = i * dt;
      time.push(t);
      N2.push(n2); H2.push(h2); NH3.push(nh3);
      
      // ì •ë°˜ì‘ê³¼ ì—­ë°˜ì‘ì˜ ì†ë„ ê³„ì‚°
      const rf = kf * n2 * Math.pow(h2, 3);
      const rr = kr * Math.pow(nh3, 2);
      const delta = rf - rr;
      
      if (i > 10) {
        // ì•”ëª¨ë‹ˆì•„ì˜ ìƒëŒ€ì  ë†ë„ ë³€í™”ìœ¨ ê³„ì‚°
        const nh3Change = Math.abs(nh3 - lastNH3);
        const relativeChange = nh3Change / (nh3 || 1e-10);  // 0ìœ¼ë¡œ ë‚˜ëˆ„ê¸° ë°©ì§€
        
        // ìµœëŒ€ NH3 ë†ë„ ì—…ë°ì´íŠ¸
        if (nh3 > maxNH3) {
          maxNH3 = nh3;
        }
        
        // í‰í˜• ë„ë‹¬ ì¡°ê±´: 
        // 1. ìƒëŒ€ì  ë³€í™”ìœ¨ì´ ë§¤ìš° ì‘ì„ ë•Œ (0.000005% ì´í•˜)
        // 2. í˜„ì¬ ë†ë„ê°€ ìµœëŒ€ ë†ë„ì˜ 99.99% ì´ìƒì¼ ë•Œ
        // 3. ë³€í™”ìœ¨ì´ ì§€ì†ì ìœ¼ë¡œ ê°ì†Œí•˜ê³  ìˆì„ ë•Œ
        if (relativeChange < 0.00000005 && nh3 >= maxNH3 * 0.9999) {
          if (lastChangeRate === null || relativeChange < lastChangeRate) {
            stableCount++;
            if (stableCount >= 10 && eqIndex === null) {
              eqIndex = i;
              console.log(`í‰í˜• ë„ë‹¬: ${t}ì´ˆ (${formatTime(t)})`);
              console.log(`NHâ‚ƒ ìƒëŒ€ ë³€í™”ìœ¨: ${(relativeChange * 100).toFixed(8)}%`);
              console.log(`NHâ‚ƒ ë†ë„: ${nh3.toFixed(3)} mol/L (ìµœëŒ€: ${maxNH3.toFixed(3)} mol/L)`);
              console.log(`ë†ë„: Nâ‚‚=${n2.toFixed(3)} mol/L, Hâ‚‚=${h2.toFixed(3)} mol/L`);
            }
          } else {
            stableCount = 0;
          }
        } else {
          stableCount = 0;
        }
        
        lastNH3 = nh3;
        lastChangeRate = relativeChange;
      }
      
      // ë†ë„ ì—…ë°ì´íŠ¸
      nh3 += 2 * delta * dt;
      n2 -= delta * dt;
      h2 -= 3 * delta * dt;
      
      if (n2 < 0) n2 = 0;
      if (h2 < 0) h2 = 0;
      if (nh3 < 0) nh3 = 0;
    }
    return { time, N2, H2, NH3, K: (kf / kr).toFixed(3), eqIndex };
  }

  // ì‹œê°„ì„ ì‹œ:ë¶„:ì´ˆ í˜•ì‹ìœ¼ë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜
  function formatTime(seconds) {
    const totalSeconds = parseFloat(seconds);
    const hours = Math.floor(totalSeconds / 3600);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    const remainingSeconds = Math.floor(totalSeconds % 60);
    return `${hours}ì‹œê°„ ${minutes}ë¶„ ${remainingSeconds}ì´ˆ`;
  }
  </script>

  <script>
  function drawChart(canvasId, result, pressure, previousData = null) {
    try {
      // ê¸°ì¡´ ì°¨íŠ¸ ì œê±°
      if (window[canvasId + '_chart']) {
        window[canvasId + '_chart'].destroy();
      }

      const ctx = document.getElementById(canvasId).getContext('2d');
      
      // ë°ì´í„° ìƒ˜í”Œë§ ìµœì í™”
      const totalHours = parseFloat(result.time[result.time.length - 1]) / 3600;
      const maxDataPoints = 500;
      const step = Math.max(1, Math.floor(result.time.length / maxDataPoints));

      // ìƒ˜í”Œë§ëœ ë°ì´í„° ìƒì„±
      const n2Data = [], h2Data = [], nh3Data = [];
      let maxN2 = 0, maxH2 = 0, maxNH3 = 0;

      // ì´ì „ ë°ì´í„° ì¶”ê°€ (2ë²ˆì§¸ ì‹œë®¬ë ˆì´í„°ì¸ ê²½ìš°)
      if (previousData && canvasId === "chart2") {
        const previousPressure = parseFloat(document.getElementById("pressure_1").value);
        const previousStep = Math.max(1, Math.floor(previousData.time.length / 50)); // ë§ˆì§€ë§‰ 40ì‹œê°„ì˜ ë°ì´í„°ë¥¼ 50ê°œ í¬ì¸íŠ¸ë¡œ ìƒ˜í”Œë§
        const startIndex = Math.max(0, previousData.time.length - Math.floor(144000 / (previousData.time[1] - previousData.time[0]))); // ë§ˆì§€ë§‰ 144000ì´ˆ(40ì‹œê°„)ì˜ ë°ì´í„°

        for (let i = startIndex; i < previousData.time.length; i += previousStep) {
          const x = (previousData.time[i] - previousData.time[startIndex]) / 3600 - 40; // -40ì‹œê°„ì—ì„œ 0ì‹œê°„ ì‚¬ì´ì— í‘œì‹œ
          const n2 = previousData.N2[i] / previousPressure;
          const h2 = previousData.H2[i] / previousPressure;
          const nh3 = previousData.NH3[i] / previousPressure;

          n2Data.push({ x, y: n2 });
          h2Data.push({ x, y: h2 });
          nh3Data.push({ x, y: nh3 });

          if (n2 > maxN2) maxN2 = n2;
          if (h2 > maxH2) maxH2 = h2;
          if (nh3 > maxNH3) maxNH3 = nh3;
        }
      }

      // í˜„ì¬ ë°ì´í„° ì¶”ê°€
      for (let i = 0; i < result.time.length; i += step) {
        const x = result.time[i] / 3600;
        const n2 = result.N2[i] / pressure;
        const h2 = result.H2[i] / pressure;
        const nh3 = result.NH3[i] / pressure;

        n2Data.push({ x, y: n2 });
        h2Data.push({ x, y: h2 });
        nh3Data.push({ x, y: nh3 });

        if (n2 > maxN2) maxN2 = n2;
        if (h2 > maxH2) maxH2 = h2;
        if (nh3 > maxNH3) maxNH3 = nh3;
      }

      const maxConcentration = Math.max(maxN2, maxH2, maxNH3);

      // í‰í˜• ë„ë‹¬ ì‹œê°„ ê³„ì‚°
      let equilibriumTime = null;
      if (result.eqIndex !== null) {
        equilibriumTime = result.time[result.eqIndex] / 3600;
      }

      // ì°¨íŠ¸ ë°ì´í„° ì¤€ë¹„
      const datasets = [
        {
          label: 'Nâ‚‚',
          data: n2Data,
          borderColor: '#0000FF',
          borderWidth: 0.25,
          pointRadius: 1,
          pointHoverRadius: 2,
          fill: false
        },
        {
          label: 'Hâ‚‚',
          data: h2Data,
          borderColor: '#008000',
          borderWidth: 0.25,
          pointRadius: 1,
          pointHoverRadius: 2,
          fill: false
        },
        {
          label: 'NHâ‚ƒ',
          data: nh3Data,
          borderColor: '#FF4500',
          borderWidth: 0.25,
          pointRadius: 1,
          pointHoverRadius: 2,
          fill: false
        }
      ];

      // ì°¨íŠ¸ ì˜µì…˜ ì„¤ì •
      const options = {
        responsive: true,
        maintainAspectRatio: false,
        animation: false,
        plugins: {
          legend: {
            position: 'top',
            usePointStyle: true,
            pointStyle: 'rect',
            padding: 10,
            font: { size: 12 }
          },
          annotation: {
            annotations: equilibriumTime ? {
              line1: {
                type: 'line',
                xMin: equilibriumTime,
                xMax: equilibriumTime,
                borderColor: 'rgb(255, 0, 0)',
                borderWidth: 2,
                borderDash: [5, 5],
                label: {
                  content: 'í‰í˜• ë„ë‹¬',
                  enabled: true,
                  position: 'top',
                  backgroundColor: 'rgba(0, 0, 0, 0.9)',
                  color: 'rgb(255, 255, 0)',
                  font: {
                    size: 12,
                    weight: 'bold'
                  }
                }
              }
            } : {}
          }
        },
        scales: {
          x: {
            type: 'linear',
            title: { display: true, text: 'ì‹œê°„ (ì‹œê°„)' },
            ticks: {
              maxTicksLimit: 10,
              font: { size: 10 }
            },
            min: canvasId === "chart2" ? -40 : undefined, // 2ë²ˆì§¸ ì°¨íŠ¸ì˜ ê²½ìš° -40ì‹œê°„ë¶€í„° ì‹œì‘
            max: canvasId === "chart2" ? totalHours : undefined // 2ë²ˆì§¸ ì°¨íŠ¸ì˜ ê²½ìš° ìµœëŒ€ ì‹œê°„ ì œí•œ
          },
          y: {
            title: { display: true, text: 'ë†ë„ (mol/L)' },
            min: 0,
            max: maxConcentration * 1.1,
            ticks: {
              font: { size: 10 }
            }
          }
        }
      };

      // ì°¨íŠ¸ ìƒì„±
      const chart = new Chart(ctx, {
        type: 'line',
        data: { datasets },
        options
      });

      window[canvasId + '_chart'] = chart;
    } catch (error) {
      console.error('ì°¨íŠ¸ ê·¸ë¦¬ê¸° ì˜¤ë¥˜:', error);
    }
  }
  </script>

  <script>
  function simulate1() {
    const n2 = parseFloat(document.getElementById("n2_1").value);
    const h2 = parseFloat(document.getElementById("h2_1").value);
    const pressure = parseFloat(document.getElementById("pressure_1").value);
    const temp = parseFloat(document.getElementById("temp_1").value);
    const time = parseFloat(document.getElementById("time_1").value);
    const catalyst = document.getElementById("catalyst_1").value;
    
    const adjusted_n2 = n2 * pressure;
    const adjusted_h2 = h2 * pressure;
    
    const result = simulateReaction(adjusted_n2, adjusted_h2, 0, temp, catalyst, time);
    final_n2 = result.N2[result.N2.length - 1];
    final_h2 = result.H2[result.H2.length - 1];
    final_nh3 = result.NH3[result.NH3.length - 1];
    lastResult1 = result;
    drawChart("chart1", result, pressure);
    
    let eqTimeText = "ê³„ì‚° ì•ˆë¨";
    if (result.eqIndex !== null) {
      const eqTime = result.time[result.eqIndex];
      eqTimeText = formatTime(eqTime);
    }
    
    document.getElementById("result1").innerHTML =
      `ğŸ“˜ K<sub>eq</sub>: ${result.K}<br>í‰í˜• ë„ë‹¬ ì‹œê°„: ${eqTimeText}<br>í‰í˜• ë†ë„ â†’ Nâ‚‚: ${(final_n2/pressure).toFixed(3)}, Hâ‚‚: ${(final_h2/pressure).toFixed(3)}, NHâ‚ƒ: ${(final_nh3/pressure).toFixed(3)}`;
  }

  function simulate2() {
    if (final_n2 === null || final_h2 === null || final_nh3 === null) {
      alert("âš ï¸ ë¨¼ì € 1ì°¨ ì‹œë®¬ë ˆì´ì…˜ì„ ì‹¤í–‰í•´ì£¼ì„¸ìš”.");
      return;
    }
    const n2_add = parseFloat(document.getElementById("n2_add").value);
    const h2_add = parseFloat(document.getElementById("h2_add").value);
    const pressure = parseFloat(document.getElementById("pressure_2").value);
    const temp = parseFloat(document.getElementById("temp_2").value);
    const time = parseFloat(document.getElementById("time_2").value);
    const catalyst = document.getElementById("catalyst_2").value;
    
    // 1ì°¨ ì‹œë®¬ë ˆì´ì…˜ì˜ ìµœì¢… ë†ë„ë¥¼ ì‹¤ì œ ë†ë„ë¡œ ë³€í™˜
    const previousPressure = parseFloat(document.getElementById("pressure_1").value);
    const actual_n2 = final_n2 / previousPressure;
    const actual_h2 = final_h2 / previousPressure;
    const actual_nh3 = final_nh3 / previousPressure;
    
    // ìƒˆë¡œìš´ ì••ë ¥ì— ë§ê²Œ ë†ë„ ì¡°ì •
    const n2 = (actual_n2 + n2_add) * pressure;
    const h2 = (actual_h2 + h2_add) * pressure;
    const nh3 = actual_nh3 * pressure;
    
    const result = simulateReaction(n2, h2, nh3, temp, catalyst, time);
    lastResult2 = result;
    drawChart("chart2", result, pressure, lastResult1);
    
    let eqTimeText = "ê³„ì‚° ì•ˆë¨";
    if (result.eqIndex !== null) {
      const eqTime = result.time[result.eqIndex];
      eqTimeText = formatTime(eqTime);
    }
    
    document.getElementById("result2").innerHTML =
      `ğŸ“• K<sub>eq</sub>: ${result.K}<br>í‰í˜• ë„ë‹¬ ì‹œê°„: ${eqTimeText}<br>í‰í˜• ë†ë„ â†’ Nâ‚‚: ${(result.N2[result.N2.length-1]/pressure).toFixed(3)}, Hâ‚‚: ${(result.H2[result.H2.length-1]/pressure).toFixed(3)}, NHâ‚ƒ: ${(result.NH3[result.NH3.length-1]/pressure).toFixed(3)}`;
  }
  </script>

  <script>
  function reset1() {
    document.getElementById("n2_1").value = 1.0;
    document.getElementById("h2_1").value = 3.0;
    document.getElementById("pressure_1").value = 200.0;
    document.getElementById("temp_1").value = 700;
    document.getElementById("time_1").value = 100;
    document.getElementById("catalyst_1").value = "none";
    document.getElementById("result1").innerHTML = "";
    if (window.chart1_chart) window.chart1_chart.destroy();
  }

  function reset2() {
    document.getElementById("n2_add").value = 0.0;
    document.getElementById("h2_add").value = 0.0;
    document.getElementById("pressure_2").value = 200.0;
    document.getElementById("temp_2").value = 700;
    document.getElementById("time_2").value = 100;
    document.getElementById("catalyst_2").value = "none";
    document.getElementById("result2").innerHTML = "";
    if (window.chart2_chart) window.chart2_chart.destroy();
  }

  function downloadCSV(data, filename) {
    if (!data) {
      alert("No data available for download");
      return;
    }

    let csv = "Time(min),N2(mol/L),H2(mol/L),NH3(mol/L)\n";
    const minuteInterval = 60; // 1ë¶„ = 60ì´ˆ
    
    for (let i = 0; i < data.time.length; i++) {
      const currentTime = parseFloat(data.time[i]);
      // 1ë¶„ ê°„ê²©ìœ¼ë¡œë§Œ ë°ì´í„° ê¸°ë¡
      if (currentTime % minuteInterval === 0) {
        const minutes = currentTime / minuteInterval;
        csv += `${minutes},${data.N2[i].toFixed(6)},${data.H2[i].toFixed(6)},${data.NH3[i].toFixed(6)}\n`;
      }
    }
    
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = filename;
    link.click();
  }
  </script>

  <script>
  // Firebase ì´ˆê¸°í™”
  const firebaseConfig = {
      // ... ê¸°ì¡´ ì„¤ì • ...
  };

  if (!firebase.apps.length) {
      firebase.initializeApp(firebaseConfig);
  }

  const db = firebase.firestore();

  // í™œë™ ì™„ë£Œ í•¨ìˆ˜
  function completeActivity() {
    const user = firebase.auth().currentUser;
    if (!user) {
      alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
      return;
    }

    const userRef = db.collection('users').doc(user.uid);
    userRef.update({
      'activities.simulator': {
        status: 'completed',
        progress: 100,
        completedAt: new Date()
      }
    }).then(() => {
      alert('í•™ìŠµì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!');
      window.location.href = '../../student_dashboard/student_dashboard.html';
    }).catch((error) => {
      console.error('Error updating document: ', error);
      alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
    });
  }

  // í˜ì´ì§€ ë¡œë“œ ì‹œ ë²„íŠ¼ ìƒíƒœ í™•ì¸
  firebase.auth().onAuthStateChanged(async (user) => {
      if (user) {
          const userDoc = await db.collection('users').doc(user.uid).get();
          const userData = userDoc.data();
          
          if (userData && userData.activities && userData.activities.simulator) {
              const completeBtn = document.querySelector('.complete-btn');
              if (userData.activities.simulator.status === 'completed') {
                  completeBtn.disabled = true;
                  completeBtn.textContent = 'ì´ë¯¸ ì™„ë£Œë¨';
              }
          }
      }
  });
  </script>
</body>
</html>
